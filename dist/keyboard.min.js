(function(){var userAgent=navigator.userAgent;if(userAgent.indexOf("Safari")>=0){browser="Safari"}else if(userAgent.indexOf("Firefox")>=0){browser="Firefox"}else if(userAgent.indexOf("IE")>=0||userAgent.indexOf("Edge")){browser="IE"}else{browser="Chrome"}if(userAgent.indexOf("Windows")>=0){os="Windows"}else if(userAgent.indexOf("Mac")>=0){os="Mac"}else if(userAgent.indexOf("iOS")>=0||userAgent.indexOf("iPhone")>=0||userAgent.indexOf("iPad")>=0){os="Mac"}else{os="Linux"}var USLocale={cancel:3,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,"pause/break":os=="Mac"&&browser!="Firefox"?126:19,caps_lock:20,esc:27,spacebar:32,pageup:33,pagedown:34,end:35,home:36,arrow_left:37,arrow_up:38,arrow_right:39,arrow_down:40,print_screen:os=="Linux"?42:os=="Mac"&&browser!="Firefox"?124:44,insert:45,delete:46,scroll_lock:os=="Mac"&&browser!="Firefox"?125:145,OS:browser=="Firefox"?os=="Mac"?224:91:[91,os=="Mac"?93:92],context_menu:os=="Mac"?0:93,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"\\":220,"[":219,"]":221,"'":222,"num_*":106,"num_+":107,num_enter:108,"num_-":109,"num_.":110,"num_/":111,num_lock:os=="Mac"?12:144,clear:os=="Mac"?12:144};var i;for(i=65;i<=90;++i){USLocale[String.fromCharCode(i+32)]=i}for(i=48;i<=57;++i){USLocale[String.fromCharCode(i)]=i}for(i=96;i<=105;++i){USLocale["num_"+(i-96)]=i}for(i=112;i<=123;++i){USLocale["F"+(i-111)]=i}if(os=="Mac"){USLocale.meta=USLocale.command=USLocale.OS}else{USLocale.meta=USLocale.ctrl;USLocale.command=0}namespace("springroll.keyboard").USLocale=USLocale})();(function(){var Application=include("springroll.Application"),Debug=include("springroll.Debug",false);var DOWN=1;var REPEAT=2;var UP=3;var Keyboard=function(target,locale){this._onFocusLost=this._onFocusLost.bind(this);this._onPaused=this._onPaused.bind(this);this._onResumed=this._onResumed.bind(this);this._update=this._update.bind(this);this._keyDown=this._keyDown.bind(this);this._keyUp=this._keyUp.bind(this);this.target=target;target.addEventListener("onblur",this._onFocusLost);var _keysByCode=this._keysByCode={};var _keysByName=this._keysByName={};this._activeCombos=[];this._updatedKeys=[];this.detectKeyCallback=null;this.detectCancelKey=null;this.detectModifiers=false;this.modifiers=["ctrl","alt","shift","command"];this.scrollKeys=["arrow_down","arrow_up","arrow_left","arrow_right","spacebar"];for(var keyName in locale){var codes=locale[keyName];if(!Array.isArray(codes))codes=[codes];var i,key=null;for(i=0;i<codes.length;++i){if(_keysByCode[codes[i]]){key=_keysByCode[codes[i]];break}}if(!key)key=new Key;key.addName(keyName);key.addCode(codes);_keysByName[keyName]=key;for(i=0;i<codes.length;++i){_keysByCode[codes[i]]=key}}this.enabled=true;var app=Application.instance;app.on("paused",this._onPaused);app.on("resumed",this._onResumed);if(app.options.preventScrollingKeys)this.restrictScrollingKeys()};var p=Keyboard.prototype;p.addKeyDown=function(keyName,callback,preventDefault){if(Array.isArray(keyName)){for(var i=0;i<keyName.length;++i)this.addKeyDown(keyName[i],callback,preventDefault);return}var key=this._keysByName[keyName];if(!key){if(Debug)Debug.warn("No key found with name '"+keyName+"'");return}key.addListener(callback,DOWN,keyName,!!preventDefault)};p.removeKeyDown=function(keyName,callback){if(Array.isArray(keyName)){for(var i=0;i<keyName.length;++i)this.removeKeyDown(keyName[i],callback,preventDefault);return}var key=this._keysByName[keyName];if(key)key.removeListener(callback,DOWN)};p.addKeyRepeat=function(keyName,callback,preventDefault){if(Array.isArray(keyName)){for(var i=0;i<keyName.length;++i)this.addKeyRepeat(keyName[i],callback,preventDefault);return}var key=this._keysByName[keyName];if(!key){if(Debug)Debug.warn("No key found with name '"+keyName+"'");return}key.addListener(callback,REPEAT,keyName,!!preventDefault)};p.removeKeyRepeat=function(keyName,callback){if(Array.isArray(keyName)){for(var i=0;i<keyName.length;++i)this.removeKeyRepeat(keyName[i],callback,preventDefault);return}var key=this._keysByName[keyName];if(key)key.removeListener(callback,REPEAT)};p.addKeyUp=function(keyName,callback,preventDefault){if(Array.isArray(keyName)){for(var i=0;i<keyName.length;++i)this.addKeyUp(keyName[i],callback,preventDefault);return}var key=this._keysByName[keyName];if(!key){if(Debug)Debug.warn("No key found with name '"+keyName+"'");return}key.addListener(callback,UP,keyName,!!preventDefault)};p.removeKeyUp=function(keyName,callback){if(Array.isArray(keyName)){for(var i=0;i<keyName.length;++i)this.removeKeyUp(keyName[i],callback,preventDefault);return}var key=this._keysByName[keyName];if(key)key.removeListener(callback,UP)};p.setPreventDefaultOnKey=function(keyName,preventDefault){if(Array.isArray(keyName)){for(var i=0;i<keyName.length;++i)this.setPreventDefaultOnKey(keyName[i],preventDefault);return}var key=this._keysByName[keyName];if(key)key.setManualPreventDefault(preventDefault)};p.restrictScrollingKeys=function(){this.setPreventDefaultOnKey(this.scrollKeys,true)};p.addCombo=function(comboString,callback,preventDefault){if(preventDefault!==false)preventDefault=true;var combo,_activeCombos=this._activeCombos;for(var i=_activeCombos.length-1;i>=0;--i){if(_activeCombos[i].name==comboString&&_activeCombos[i].preventDefault==preventDefault){combo=_activeCombos[i];break}}if(!combo){combo=new Combo(comboString,preventDefault,this._keysByName);_activeCombos.push(combo)}combo.addListener(callback)};p.removeCombo=function(comboString,callback){var _activeCombos=this._activeCombos;for(var i=_activeCombos.length-1;i>=0;--i){if(_activeCombos[i].name==comboString){if(_activeCombos[i].removeListener(callback)){if(i==_activeCombos.length-1)_activeCombos.pop();else _activeCombos.splice(i,1)}}}};p.detectNextKey=function(callback,cancelKey,allowModifiers){if(cancelKey===undefined)cancelKey=this._keysByName.esc;else if(cancelKey)cancelKey=this._keysByName[cancelKey];this.detectKeyCallback=callback;this.detectCancelKey=cancelKey||null;this.detectModifiers=!!allowModifiers};p.stopDetecting=function(){this.detectKeyCallback=null;this.detectCancelKey=null};p.justPressed=function(keyName){var key=this._keysByName[keyName];if(key)return key.justDown;else return false};p.isDown=function(keyName){var key=this._keysByName[keyName];if(key)return key.isDown;else return false};p.justReleased=function(keyName){var key=this._keysByName[keyName];if(key)return key.justUp;else return false};Object.defineProperty(p,"enabled",{get:function(){return this._enabled},set:function(value){this._enabled=value;var target=this.target;target.removeEventListener("keydown",this._keyDown,true);target.removeEventListener("keyup",this._keyUp,true);Application.instance.off("update",this._update);if(value){target.addEventListener("keydown",this._keyDown,true);target.addEventListener("keyup",this._keyUp,true);Application.instance.on("update",this._update,-1e3)}else this.clearKeys()}});p.clearKeys=function(){var _keysByCode=this._keysByCode;if(!_keysByCode)return;for(var code in _keysByCode){var key=_keysByCode[code];key.isDown=key.justDown=key.justUp=false}};p._onFocusLost=function(ev){this.clearKeys()};p._onPaused=function(){this.enabled=false};p._onResumed=function(){this.enabled=true;var target=this.target;if(target&&target.focus)target.focus()};p._update=function(elapsed){var _updatedKeys=this._updatedKeys;if(!_updatedKeys||!_updatedKeys.length)return;for(var i=_updatedKeys.length-1;i>=0;--i){var key=_updatedKeys[i];key.justDown=key.justUp=false}_updatedKeys.length=0};p._keyDown=function(ev){var key=this._keysByCode[ev.keyCode];var i;if(this.detectKeyCallback){var callback=this.detectKeyCallback;if(key&&key==this.detectCancelKey){this.detectKeyCallback=null;callback(null)}else{var wasModifier=false;var modifiers=this.modifiers;if(this.detectModifiers){for(i=0;i<modifiers.length;++i){if(key===this._keysByName[modifiers[i]]){wasModifier=true;break}}}if(!wasModifier){this.detectKeyCallback=null;if(!key){key=new Key(ev.keyCode,"key_"+ev.keyCode);this._keysByCode[ev.keyCode]=key;this._keysByName[key.name]=key}var detected=key.preferredName;if(this.detectModifiers){for(i=0;i<modifiers.length;++i){if(this._keysByName[modifiers[i]].isDown){detected=modifiers[i]+" + "+detected}}}callback(detected)}}}if(key){var preventDefault=false;if(key.isDown){key.trigger(REPEAT)}else{key.isDown=key.justDown=true;if(this._updatedKeys.indexOf(key)==-1)this._updatedKeys.push(key);key.trigger(DOWN);for(i=this._activeCombos.length-1;i>=0;--i){if(this._activeCombos[i].testKeyDown(ev.keyCode))preventDefault=true}}if(key.shouldPreventDefault||preventDefault){ev.preventDefault();return true}}};p._keyUp=function(ev){var key=this._keysByCode[ev.keyCode];if(key){var preventDefault=false;if(key.isDown){key.isDown=false;key.justUp=true;if(this._updatedKeys.indexOf(key)==-1)this._updatedKeys.push(key);key.trigger(UP);for(var i=this._activeCombos.length-1;i>=0;--i){if(this._activeCombos[i].testKeyUp(ev.keyCode))preventDefault=true}}if(key.shouldPreventDefault||preventDefault){ev.preventDefault();return true}}};p.destroy=function(){this.enabled=false;var app=Application.instance;if(app){app.off("paused",this._onPaused);app.off("resumed",this._onResumed)}this.target.removeEventListener("onblur",this._onFocusLost);var i;for(i in this._keysByCode)this._keysByCode[i].destroy();for(i=this._activeCombos.length-1;i>=0;--i)this._activeCombos[i].destroy();this._keysByCode=this._keysByName=this._updatedKeys=this._activeCombos=this.target=null;this._update=this._keyDown=this._keyUp=this._onResumed=this._onPaused=this._onFocusLost=null};namespace("springroll").Keyboard=Keyboard;var Key=function(){this.codes=[];this.names=[];this.preferredName=null;this.upListeners=[];this.repeatListeners=[];this.downListeners=[];this.manualPreventDefault=false;this.shouldPreventDefault=false;this.isDown=false;this.justDown=false;this.justUp=false};p=Key.prototype;p.addCode=function(code){if(Array.isArray(code)){for(var i=0;i<code.length;++i)this.codes.push(code[i])}else this.codes.push(code)};p.addName=function(name){if(!this.names.length)this.preferredName=name;this.names.push(name)};p.setManualPreventDefault=function(preventDefault){this.manualPreventDefault=preventDefault;if(preventDefault){this.shouldPreventDefault=true}else{preventDefault=false;var listenerList=[this.downListeners,this.repeatListeners,this.upListeners];for(var i=0;i<listenerList.length&&!preventDefault;++i){var listeners=listenerList[i];for(var index=listeners.length-1;index>=0;--index){if(listeners[index]&&listeners[index].preventDefault){preventDefault=true;break}}}this.shouldPreventDefault=preventDefault}};p.addListener=function(listener,type,requestedName,preventDefault){var listeners;switch(type){case DOWN:listeners=this.downListeners;break;case REPEAT:listeners=this.repeatListeners;break;case UP:listeners=this.upListeners;break}if(listeners.indexOf(listener)==-1)listeners.push(listener);if(this.preferredName!=requestedName)this.preferredName=requestedName;listener.preventDefault=preventDefault;if(preventDefault){this.shouldPreventDefault=true}};p.removeListener=function(listener,type){var listeners;switch(type){case DOWN:listeners=this.downListeners;break;case REPEAT:listeners=this.repeatListeners;break;case UP:listeners=this.upListeners;break}var index=listeners.indexOf(listener);if(index>=0){if(index<1)listeners.shift();else listeners.splice(index,1)}this.setManualPreventDefault(this.manualPreventDefault)};p.trigger=function(type){var listeners;switch(type){case DOWN:listeners=this.downListeners;break;case REPEAT:listeners=this.repeatListeners;break;case UP:listeners=this.upListeners;break}for(var i=0;i<listeners.length;++i){listeners[i](this.preferredName)}};p.destroy=function(){this.codes=this.names=this.upListeners=this.repeatListeners=this.downListeners=null};var Combo=function(name,preventDefault,keysByNameRef){this.name=name;this.listeners=[];this.steps=[];this.currentStep=0;this.preventDefault=preventDefault;var steps=name.split(/\s+>\s+/g);for(var i=0;i<steps.length;++i){var stepNames=steps[i].split(/\s+\+\s+/g);var step=[];for(var j=0;j<stepNames.length;++j){var keyName=stepNames[j];if(keyName=="\\>")keyName=">";else if(keyName=="\\+")keyName="+";var key=keysByNameRef[keyName];if(!key){if(Debug)Debug.warn("Issue while creating combo - no key with name "+keyName);continue}step.push({sated:false,released:false,codes:key.codes})}if(step.length)this.steps.push(step)}};p=Combo.prototype;p.testKeyDown=function(keyCode){var step=this.steps[this.currentStep];var found=false,i,key;for(i=0;i<step.length;++i){key=step[i];if(key.codes.indexOf(keyCode)>=0){if(key.sated)break;key.sated=true;found=true;break}}if(!found){this.resetStep();this.currentStep=0;return false}var allSuccess=true;for(i=0;i<step.length;++i){key=step[i];if(!key.sated){allSuccess=false;break}}if(allSuccess&&this.currentStep+1==this.steps.length){this.trigger();this.resetStep();this.currentStep=0}return this.preventDefault};p.testKeyUp=function(keyCode){var step=this.steps[this.currentStep];var found=false,i,key;for(i=0;i<step.length;++i){key=step[i];if(key.sated&&key.codes.indexOf(keyCode)>=0){key.released=true;found=true;break}}if(found){var allReleased=true;for(i=0;i<step.length;++i){if(!step[i].released){allReleased=false;break}}if(allReleased){this.resetStep();++this.currentStep}}return found&&this.preventDefault};p.resetStep=function(){var step=this.steps[this.currentStep];for(i=0;i<step.length;++i){key=step[i];key.sated=key.released=false}};p.trigger=function(){var listeners=this.listeners;for(var i=0;i<listeners.length;++i){listeners[i](this.name)}};p.addListener=function(listener){var listeners=this.listeners;if(listeners.indexOf(listener)==-1)listeners.push(listener)};p.removeListener=function(listener){var listeners=this.listeners,index=listeners.indexOf(listener);if(index>=0){if(index<1)listeners.shift();else listeners.splice(index,1)}return listeners.length<1};p.destroy=function(){this.listeners=this.steps=null}})();(function(){var Keyboard=include("springroll.Keyboard"),ApplicationPlugin=include("springroll.ApplicationPlugin"),USLocale=include("springroll.keyboard.USLocale");var plugin=new ApplicationPlugin;plugin.setup=function(){this.options.add("keyboardLocale",USLocale,true);this.options.add("keyboardTarget",null,true);this.options.add("preventScrollingKeys",false,true)};plugin.preload=function(done){var options=this.options;options.asDOMElement("keyboardTarget");options.keepFocus=true;var target=options.keyboardTarget||document;var locale=options.keyboardLocale||USLocale;this.keyboard=new Keyboard(target,locale);done()};plugin.teardown=function(){this.keyboard.destroy();this.keyboard=null}})();
